# SPDX-License-Identifier: GPL-2.0
# Copyright (C) 2024-present ROCKNIX (https://github.com/ROCKNIX)

DTBXML="${PROJECT_DIR}/${PROJECT}/bootloader/dtb.xml"

mkdir -p "${INSTALL}/usr/share/bootloader/EFI/BOOT"
cat << EOF > "${INSTALL}/usr/share/bootloader/EFI/BOOT/grub.cfg"
insmod part_gpt
insmod part_msdos
load_env

if [ "\${saved_entry}" ]; then
  set timeout=2
  set default="\${saved_entry}"
else
  set timeout=-1
fi

if [ x"\${feature_menuentry_id}" = xy ]; then
  menuentry_id_option="--id"
else
  menuentry_id_option=""
fi
export menuentry_id_option

function savedefault {
  saved_entry="\${chosen}"
  save_env saved_entry
}

set timeout_style=menu
set lang=en_US
loadfont /EFI/BOOT/dejavu-mono.pf2
set rotation=270
set gfxmode=auto
insmod efi_gop
insmod gfxterm
terminal_output gfxterm
set menu_color_normal=cyan/blue
set menu_color_highlight=white/blue

EOF

xmlstarlet sel -t -m "//${DEVICE}/file" \
  -v "concat(@short, '|', @full, '|', .)" -n "${DTBXML}" | while IFS='|' read -r SHORT FULL DTB; do

  cat << EOF >> "${INSTALL}/usr/share/bootloader/EFI/BOOT/grub.cfg"
menuentry '${FULL}' \$menuentry_id_option '${SHORT}' {
        savedefault
        search --set -f /KERNEL
        linux /KERNEL boot=LABEL=${DISTRO_BOOTLABEL} disk=LABEL=${DISTRO_DISKLABEL} grub_portable ${EXTRA_CMDLINE}
        devicetree /${DTB}.dtb
}
EOF
done

xmlstarlet sel -t -m "//${DEVICE}/file" \
  -v "concat(@short, '|', @full, '|', .)" -n "${DTBXML}" | while IFS='|' read -r SHORT FULL DTB; do

  cat << EOF >> "${INSTALL}/usr/share/bootloader/EFI/BOOT/grub.cfg"
menuentry '${FULL} RECOVERY' \$menuentry_id_option '${SHORT}-recovery' {
        search --set -f /KERNEL
        linux /KERNEL boot=LABEL=${DISTRO_BOOTLABEL} disk=LABEL=${DISTRO_DISKLABEL} grub_portable ${EXTRA_CMDLINE} recovery
        devicetree /${DTB}.dtb
}
EOF
done
